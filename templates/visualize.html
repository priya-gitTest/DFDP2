<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Knowledge Graph Visualization</title>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            body { margin: 0; font-family: sans-serif; }
            .header { background-color: #1a2b47; }
            .controls { position: absolute; top: 80px; left: 10px; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 5px; }
            .links line { stroke: #999; stroke-opacity: 0.6; }
            .nodes circle { stroke: #fff; stroke-width: 1.5px; }
            .node-label { font-size: 10px; fill: #333; pointer-events: none; }
            .link-label { font-size: 8px; fill: #555; pointer-events: none; }
        </style>
    </head>
    <body>
        <header class="header text-white p-4 shadow-md fixed top-0 left-0 right-0 z-10">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">Knowledge Graph Visualization</h1>
                <nav>
                    <a href="/" class="px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-gray-700">Home</a>
                    <a href="/catalog" class="px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-gray-700">Catalog</a>
                </nav>
            </div>
        </header>

        <div id="graph-container"></div>
        
        <script>
            const width = window.innerWidth;
            const height = window.innerHeight;

            const svg = d3.select("#graph-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .call(d3.zoom().on("zoom", (event) => {
                    g.attr("transform", event.transform)
                }));

            const g = svg.append("g");

            const color = d3.scaleOrdinal(d3.schemeCategory10);

            const simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(width / 2, height / 2));

            d3.json("/graph-data").then(function(graph) {
                const link = g.append("g")
                    .attr("class", "links")
                    .selectAll("line")
                    .data(graph.links)
                    .enter().append("line")
                    .attr("stroke-width", 1.5);

                const node = g.append("g")
                    .attr("class", "nodes")
                    .selectAll("circle")
                    .data(graph.nodes)
                    .enter().append("circle")
                    .attr("r", 10)
                    .attr("fill", d => color(d.group))
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                const nodeLabels = g.append("g")
                    .selectAll("text")
                    .data(graph.nodes)
                    .enter().append("text")
                    .attr("class", "node-label")
                    .attr("dx", 12)
                    .attr("dy", ".35em")
                    .text(d => d.label);
                
                const linkLabels = g.append("g")
                    .selectAll("text")
                    .data(graph.links)
                    .enter().append("text")
                    .attr("class", "link-label")
                    .text(d => d.predicate);

                node.append("title")
                    .text(d => d.id);

                simulation
                    .nodes(graph.nodes)
                    .on("tick", ticked);

                simulation.force("link")
                    .links(graph.links);

                function ticked() {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);
                    
                    nodeLabels
                        .attr("x", d => d.x)
                        .attr("y", d => d.y);

                    linkLabels
                        .attr("x", d => (d.source.x + d.target.x) / 2)
                        .attr("y", d => (d.source.y + d.target.y) / 2);
                }
            });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        </script>
    </body>
    </html>
