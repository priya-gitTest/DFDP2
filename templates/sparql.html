{% extends "base.html" %}

{% block content %}
<div class="flex flex-col items-center justify-center text-center">
    <h1 class="text-4xl font-bold text-gray-900 mb-6">SPARQL Query Interface</h1>
    <p class="text-lg text-gray-600 max-w-2xl mb-8">
        Run your own SPARQL queries against the DICOM knowledge graph.
    </p>

    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-4xl">
        <form id="sparql-form">
            <textarea id="query-input" rows="10" class="w-full p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm" placeholder="Enter your SPARQL query here...
Example:
PREFIX dcat: <http://www.w3.org/ns/dcat#>
PREFIX dcterms: <http://purl.org/dc/terms/>
SELECT ?dataset ?title WHERE {
    ?catalog a dcat:Catalog .
    ?catalog dcat:dataset ?dataset .
    ?dataset dcterms:title ?title .
}
            "></textarea>
            <button type="submit" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Run Query
            </button>
        </form>

        <div id="results-container" class="mt-8 text-left hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Query Results</h2>
            <div id="results-table-container" class="overflow-x-auto">
                <!-- Results table will be rendered here -->
            </div>
        </div>
        
        <div id="message-box" class="mt-4 hidden p-4 rounded-lg text-sm" role="alert"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('sparql-form');
        const queryInput = document.getElementById('query-input');
        const resultsContainer = document.getElementById('results-container');
        const resultsTableContainer = document.getElementById('results-table-container');
        const messageBox = document.getElementById('message-box');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Clear previous results and messages
            resultsContainer.classList.add('hidden');
            messageBox.classList.add('hidden');
            messageBox.textContent = '';
            resultsTableContainer.innerHTML = '';
            
            const query = queryInput.value;
            if (!query) {
                showMessage('Please enter a SPARQL query.', 'bg-yellow-100 text-yellow-800');
                return;
            }

            try {
                const response = await fetch(`${window.location.origin}/sparql`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'An unknown error occurred.');
                }

                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    renderResultsTable(data.results);
                    resultsContainer.classList.remove('hidden');
                } else {
                    showMessage('The query returned no results.', 'bg-gray-200 text-gray-800');
                }

            } catch (error) {
                console.error('Error executing query:', error);
                showMessage(`Error: ${error.message}`, 'bg-red-100 text-red-800');
            }
        });

        function renderResultsTable(results) {
            if (results.length === 0) return;

            const headers = Object.keys(results[0]);
            
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            
            // Table Header
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-gray-50';
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            // Table Body
            const tbody = table.createTBody();
            tbody.className = 'bg-white divide-y divide-gray-200';
            results.forEach(row => {
                const tr = tbody.insertRow();
                headers.forEach(header => {
                    const td = tr.insertCell();
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    td.textContent = row[header];
                });
            });

            resultsTableContainer.appendChild(table);
        }

        function showMessage(message, className) {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-4 rounded-lg text-sm ${className}`;
            messageBox.classList.remove('hidden');
        }
    });
</script>
{% endblock %}
